<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.stats.lolgg.mapper.LeagueMapper">

    <!-- SELECT -->

    <!-- 전체 조회 (조건 없음) -->
    <select id="findAll" resultType="com.stats.lolgg.model.LeagueVO">
        SELECT 
            ID, 
            GAME_ID, 
            RIOT_NAME, 
            CHAMP_NAME, 
            POSITION, 
            KDA, 
            GAME_RESULT, 
            GAME_TEAM, 
            GAME_DATE, 
            CREATE_DATE,
            DELETE_YN
        FROM LEAGUE

    </select>

    <!-- 최근 TOP 10 조회 (riot_name) -->
    <select id="findTop10" parameterType="String" resultType="com.stats.lolgg.model.LeagueVO">
        SELECT 
            ID, 
            GAME_ID, 
            RIOT_NAME, 
            CHAMP_NAME, 
            POSITION, 
            KDA, 
            GAME_RESULT, 
            GAME_TEAM, 
            GAME_DATE
        FROM LEAGUE
        WHERE RIOT_NAME = #{riot_name}
        AND DELETE_YN = 'N'
        AND GAME_DATE <![CDATA[ < ]]> CURRENT_TIMESTAMP 
        ORDER BY ABS(EXTRACT(EPOCH FROM CURRENT_TIMESTAMP - GAME_DATE))
        LIMIT 10

    </select>

    <!-- 전체 전적 조회 (riot_name) -->
    <select id="findRecord" parameterType="String" resultType="java.util.hashMap">
        SELECT 
            POSITION,
            COUNT(*) AS TOTAL_COUNT,
            COUNT(CASE WHEN GAME_RESULT = '승' THEN 1 END) AS WIN,
            COUNT(CASE WHEN GAME_RESULT = '패' THEN 1 END) AS LOSE
        FROM LEAGUE
        WHERE RIOT_NAME = #{riot_name}
        AND DELETE_YN = 'N'
        GROUP BY POSITION
    </select>

    <!-- 최근 전적 한달 조회 (riot_name) -->
    <select id="findRecordOneMonth" parameterType="String" resultType="java.util.hashMap">
        SELECT 
            COUNT(*) AS TOTAL_COUNT,
            COUNT(CASE WHEN GAME_RESULT = '승' THEN 1 END) AS WIN,
            COUNT(CASE WHEN GAME_RESULT = '패' THEN 1 END) AS LOSE
        FROM LEAGUE
        WHERE RIOT_NAME = #{riot_name}
        AND DELETE_YN = 'N'
        <![CDATA[
        AND GAME_DATE >= DATE_TRUNC('month', CURRENT_TIMESTAMP)
        AND GAME_DATE < DATE_TRUNC('month', CURRENT_TIMESTAMP) + INTERVAL '1 month'
        ]]>
    </select>

    <!-- 모스트 픽 (riot_name) -->
    <select id="findMostPick" parameterType="String" resultType="java.util.hashMap">
        SELECT 
            CHAMP_NAME,
            COUNT(CHAMP_NAME) AS TOTAL_COUNT,
            COUNT(CASE WHEN GAME_RESULT = '승' THEN 1 END) AS WIN,
            COUNT(CASE WHEN GAME_RESULT = '패' THEN 1 END) AS LOSE
        FROM LEAGUE
        WHERE RIOT_NAME = #{riot_name}
        AND DELETE_YN = 'N'
        GROUP BY CHAMPAME, GAME_RESULT
        LIMIT 10

    </select>

    <!-- INSERT  -->

    <!-- 리플 데이터 저장 -->
    <insert id="insertLeague" parameterType="java.util.List">
        INSERT INTO LEAGUE
            (
                id,
                game_id,
                riot_name,
                champ_name,
                position,
                kda,
                game_result,
                game_team,
                game_date,
                create_date,
                delete_yn
            )
            VALUES
            <foreach collection="list" item="item" separator=",">
                (
                    nextval('league_id_seq'),
                    #{item.game_id},
                    #{item.riot_name},
                    #{item.champ_name},
                    #{item.position},
                    #{item.kda},
                    #{item.game_result},
                    #{item.game_team},
                    #{item.game_date},
                    CURRENT_TIMESTAMP,
                    #{item.delete_yn}
                )
            </foreach>
    </insert>

    <!-- UPDATE -->

    <!-- 탈퇴회원처리 -->


</mapper>